app-id: %(PORTNAME)s
runtime: org.gnome.Platform
runtime-version: "3.28"
# Control the exact version of the Sdk/Runtime that is being used.
sdk-hash: cea71fe86d6961b4fe58046170f8dc8f8d4d04141ddf211e7cc6db44a18a0c49
runtime-hash: 9785cf7dc62290d76eef4bf0f5d25240fc5bb3d73128c25e95c4e4cb90bb3560
sdk: org.gnome.Sdk
command: %(COMMAND)s
finish-args:
  # Basically no sandboxing, the goal here is to make it flexible
  # for developers, not really to isolate (openning all devices
  # to allow acces video cameras until we have a portal at least).
  - --share=ipc
  - --socket=x11
  - --socket=wayland
  - --device=all
  - --share=network
  - --socket=pulseaudio
  - --system-talk-name=org.freedesktop.GeoClue2
  - --filesystem=host
  - --filesystem=/tmp
  - --socket=system-bus
  - --talk-name=org.freedesktop.Flatpak
build-options:
  cflags: -O2 -g
  cxxflags: -O2 -g
  strip: false
  no-debuginfo: true
modules:
  # http and dependencies.
  - name: apr
    sources:
      - type: archive
        url: https://www.apache.org/dist/apr/apr-1.6.3.tar.bz2
        sha256: 131f06d16d7aabd097fa992a33eec2b6af3962f93e6d570a9bd4d85e95993172
  - name: apr-util
    sources:
      - type: archive
        url: https://www.apache.org/dist/apr/apr-util-1.6.1.tar.bz2
        sha512: "40eff8a37c0634f7fdddd6ca5e596b38de15fd10767a34c30bbe49c632816e8f3e1e230678034f578dd5816a94f246fb5dfdf48d644829af13bf28de3225205d"
    config-opts:
      - --with-apr=/app/bin/apr-1-config
  - name: httpd
    sources:
      - type: git
        url: https://github.com/apache/httpd.git
        branch: 2.4.33
      - type : file
        path : files/httpd-autogen.sh
        dest-filename : autogen.sh
      # The version embedded in the sandbox doesn't have a working pcre-config
      - type: patch
        path: patches/httpd-0001-configure-use-pkg-config-for-PCRE-detection.patch
    config-opts:
      - --enable-mpms-shared=all
      - --enable-modules=all
      - --with-apr=/app/bin/apr-1-config
      - --with-apr-util=/app/bin/apu-1-config
      - --with-pcre=/app
      - --enable-authnz-fcgi
      - --enable-cgi
      - --enable-cgid
  - name: php
    sources:
      - type: archive
        url: https://php.net/distributions/php-7.2.6.tar.xz
        sha512: da86b1ff2df3b9e2d46e59a80296b940d81132975b621bdec9602f8b4c8d91a3fdcd4ffd7cb982d63d3ec974b3a12a7854e42a73b7f2cc8eefade14335aa7c71
    config-opts:
      - --disable-xml
      - --disable-dom
      - --disable-libxml
      - --disable-simplexml
      - --disable-xmlreader
      - --disable-xmlwriter
      - --without-pear
      - --with-apxs2
  - name: libevent
    sources:
      - type: git
        url: https://github.com/libevent/libevent.git
        branch: e7ff4ef # 2.1.8
    config-opts:
      - --disable-libevent-regress

  # GStreamer modules
  - name: libvpx
    no-autogen: true
    sources:
      - type: git
        url: https://chromium.googlesource.com/webm/libvpx
        branch: v1.7.0
    config-opts:
      - --enable-pic
      - --as=yasm
      - --disable-unit-tests
      - --size-limit=16384x16384
      - --enable-postproc
      - --enable-multi-res-encoding
      - --enable-temporal-denoising
      - --enable-vp9-temporal-denoising
      - --enable-vp9-postproc
      - --enable-shared
  - name: gstreamer
    buildsystem: meson
    sources:
      - type: git
        url: https://anongit.freedesktop.org/git/gstreamer/gstreamer
        branch: 1.14.1
    config-opts:
      - -Ddisable_gtkdoc=true
  - name: gst-plugins-base
    buildsystem: meson
    sources:
      - type: git
        url: https://anongit.freedesktop.org/git/gstreamer/gst-plugins-base
        branch: 1.14.1
    config-opts:
      - -Ddisable_gtkdoc=true
  - name: gst-plugins-good
    buildsystem: meson
    sources:
      - type: git
        url: https://anongit.freedesktop.org/git/gstreamer/gst-plugins-good
        branch: 1.14.1
      - type: patch
        path: ../gstreamer/patches/gst-plugins-good-0002-qtdemux-add-context-for-a-preferred-protection.patch
      - type: patch
        path: ../gstreamer/patches/gst-plugins-good-0003-qtdemux-also-push-buffers-without-encryption-info-in.patch
      - type: patch
        path: ../gstreamer/patches/gst-plugins-good-0001-qtdemux-Do-not-run-the-preferred-decryptor-context-q.patch
      - type: patch
        path: ../gstreamer/patches/gst-plugins-good-0002-qtdemux-Do-not-unref-a-NULL-stream_tags.patch
      - type: patch
        path: ../gstreamer/patches/gst-plugins-good-0003-qtdemux-Clarify-field-name-about-stream-encryption-s.patch
    config-opts:
      - -Ddisable_gtkdoc=true
  - name: gst-plugins-ugly
    buildsystem: meson
    sources:
      - type: git
        url: https://anongit.freedesktop.org/git/gstreamer/gst-plugins-ugly
        branch: 1.14.1
    config-opts:
      - -Ddisable_gtkdoc=true
  - name: gst-plugins-bad
    buildsystem: meson
    sources:
      - type: git
        url: https://anongit.freedesktop.org/git/gstreamer/gst-plugins-bad
        branch: 1.14.1
    config-opts:
      - -Ddisable_gtkdoc=true

  # Port specific components.
  - %(PORTNAME)s.yaml